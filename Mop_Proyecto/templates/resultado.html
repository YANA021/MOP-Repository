{% extends 'base.html' %}
{% block title %}Resultado{% endblock %}
{% block content %}
<h1 class="text-2xl mb-4">Resultado</h1>
{% if mensaje %}<p>{{ mensaje }}</p>{% endif %}
{% if resultado %}
    <p>Status: {{ resultado.status }}</p>
    <p>x1: {{ resultado.x }}</p>
    <p>x2: {{ resultado.y }}</p>
    <p>z: {{ resultado.z }}</p>
    <p class="mb-2"><strong>Función Objetivo:</strong> {{ objetivo }}</p>

    <p class="font-semibold">Sujeto a:</p>
    <ul class="list-disc ml-5 mb-4">
        {% for r in restricciones %}
            <li>{{ r }}</li>
        {% endfor %}
    </ul>

    <div id="plot" data-restr-count="{{ restricciones|length }}">{{ grafico|safe }}</div>

    <h2 class="text-xl mt-4 mb-2">Etiquetas del Gráfico</h2>
       <div class="flex flex-wrap items-center gap-4 mb-4">
        <label class="inline-flex items-center gap-1">
            <input type="checkbox" id="chk-restr" checked> Restricciones
        </label>
        <label class="inline-flex items-center gap-1">
            <input type="checkbox" id="chk-obj" checked> Función Objetivo
        </label>
        <label class="inline-flex items-center gap-1">
            <input type="checkbox" id="chk-vert" checked> Puntos de Región Factible
        </label>
        <label class="inline-flex items-center gap-1">
            <input type="checkbox" id="chk-grid" checked> Cuadrícula
        </label>
       <label class="inline-flex items-center gap-1 ml-auto">
            <span>Formato</span>
            <select id="img-format" class="form-theme">
                <option value="png">PNG</option>
                <option value="pdf">PDF</option>
                <option value="svg">SVG</option>
            </select>
        </label>
        <button id="save-img" class="btn-primary-theme">Descargar</button>
    </div>

    <div class="overflow-x-auto">
    <table class="min-w-full text-center mt-4">
        <thead>
            <tr class="bg-gray-200">
                <th class="px-2 py-1">Punto</th>
                <th class="px-2 py-1">Coordenadas</th>
                <th class="px-2 py-1">Valor Z</th>
            </tr>
        </thead>
        <tbody>
            {% for v in vertices %}
            <tr class="{% if v.optimo %}bg-red-200{% endif %}">
                <td class="border px-2 py-1">{{ v.punto }}</td>
                <td class="border px-2 py-1">({{ v.x1 }}, {{ v.x2 }})</td>
                <td class="border px-2 py-1">{{ v.z }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
/* @ts-nocheck */
document.addEventListener('DOMContentLoaded', () => {
    const figDiv = document.querySelector('#plot .plotly-graph-div');
    if (!figDiv) return;

    const restrCount = parseInt(
        document.getElementById('plot').dataset.restrCount,
        10
    );

    const chkRestr = document.getElementById('chk-restr');
    const chkObj   = document.getElementById('chk-obj');
    const chkVert  = document.getElementById('chk-vert');
    const chkGrid  = document.getElementById('chk-grid');
    const btnSave  = document.getElementById('save-img');
    const formatSel = document.getElementById('img-format');

    chkRestr.addEventListener('change', () => {
        const idx = [...Array(restrCount).keys()];
        Plotly.restyle(figDiv, 'visible',
                       chkRestr.checked ? true : 'legendonly',
                       idx);
    });

    const idxObj  = restrCount + 1;
    const idxVert = [restrCount + 2, restrCount + 3];

    chkObj.addEventListener('change', () => {
        Plotly.restyle(figDiv, 'visible',
                       chkObj.checked ? true : 'legendonly',
                       [idxObj]);
    });

    chkVert.addEventListener('change', () => {
        Plotly.restyle(figDiv, 'visible',
                       chkVert.checked ? true : 'legendonly',
                       idxVert);
    });

    chkGrid.addEventListener('change', () => {
        Plotly.relayout(figDiv, {
            'xaxis.showgrid': chkGrid.checked,
            'yaxis.showgrid': chkGrid.checked
        });
    });

    btnSave.addEventListener('click', () => {
       const fmt = formatSel ? formatSel.value : 'png';
        Plotly.downloadImage(figDiv, { format: fmt, filename: 'grafico' });
    });
});
</script>
{% endblock %}